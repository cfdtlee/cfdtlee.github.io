<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Add Advertisement on a bunch of videos | cfdtlee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="description" content="Task: In order to advertise a company, I have to download a bunch of(1000 or so) videos related to the company from Youku, then add title sequence and watermark(or say subtitles), finally upload all of them to Youku.
I’ve tried Adobe Premiere, OpenCV, and finally use ffmpeg and python to accomplish this task.
Here is how I hacked the task.">
  
  
    <link rel="alternate" href="/atom.xml" title="cfdtlee" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox-1.3.4.css">

  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">cfdtlee</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">We do what we have to do, so we can do what we want to do</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Coding-edit_videos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2014/12/24/Coding-edit_videos/" class="article-date">
  <time class="dt-published" datetime="2014-12-23T23:56:28.000Z" itemprop="datePublished">2014-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Hack/">Hack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Add Advertisement on a bunch of videos
    </h1>
  

      </header>
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Task: In order to advertise a company, I have to download a bunch of(1000 or so) videos related to the company from <a target="_blank" rel="noopener" href="http://www.youku.com/">Youku</a>, then add title sequence and watermark(or say subtitles), finally upload all of them to <a target="_blank" rel="noopener" href="http://www.youku.com/">Youku</a>.</p>
<p>I’ve tried Adobe Premiere, OpenCV, and finally use ffmpeg and python to accomplish this task.</p>
<p>Here is how I hacked the task.</p>
<span id="more"></span>

<h2 id="Download-Videos"><a href="#Download-Videos" class="headerlink" title="Download Videos"></a>Download Videos</h2><ol>
<li>Find the video I want to download.</li>
<li>Use <a target="_blank" rel="noopener" href="http://www.flvcd.com/">flvcd</a> to get the downloadable link.</li>
<li>Download it.</li>
</ol>
<p>I have to do 1 to 3 in loop, so I write python script to do this.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_url_content can return the html text of given url. It comouflage my python program as a browser.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_url_content</span>(<span class="params">url</span>):</span></span><br><span class="line">    i_headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.1) Gecko/20090624 Firefox/3.5&quot;</span>,\</span><br><span class="line">                 <span class="string">&quot;Referer&quot;</span>: <span class="string">&#x27;http://www.baidu.com&#x27;</span>&#125;</span><br><span class="line">    req = urllib2.Request(url, headers=i_headers)</span><br><span class="line">    <span class="keyword">return</span> urllib2.urlopen(req).read()</span><br><span class="line"></span><br><span class="line">fopen = <span class="built_in">open</span>(<span class="string">&#x27;result.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="comment">#result.py contains video links in python syntax.</span></span><br><span class="line">result = fopen.read()</span><br><span class="line">urls = <span class="built_in">eval</span>(result) <span class="comment"># transform string into python object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    title = url[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">    href = url[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">    flvcd_url = <span class="string">&#x27;http://www.flvcd.com/parse.php?kw=&#x27;</span> + href</span><br><span class="line">    html = get_url_content(flvcd_url)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># use regular expression to extract downloadable links</span></span><br><span class="line">    download_urls = re.findall(<span class="string">r&#x27;href=&quot;http://k.youku.com/player/getFlvPath/sid/[.\S]+&#x27;</span>, html)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># because some video is divided into several part, so I use for loop to download them respectively by using urllib.urlretrieve().</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(download_urls)):</span><br><span class="line">        urllib.urlretrieve(download_urls[i][<span class="number">6</span>:], <span class="string">&#x27;./videos/&#x27;</span>+title+<span class="built_in">str</span>(i)+<span class="string">&#x27;.flv&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="Edit-videos"><a href="#Edit-videos" class="headerlink" title="Edit videos"></a>Edit videos</h2><h3 id="Adobe-Premiere"><a href="#Adobe-Premiere" class="headerlink" title="Adobe Premiere"></a>Adobe Premiere</h3><p>Adobe <a target="_blank" rel="noopener" href="http://www.adobe.com/products/premiere.html">Premiere</a> is one of the most powerful video edit tools. It works very well on generating single output. However, we have to deal with a thousand videos repeatedly, it would be time consuming.</p>
<p>Computer does repeated things better than human, so I try to write lines of program to do that, and here is my attempts:</p>
<h3 id="OpenCV"><a href="#OpenCV" class="headerlink" title="OpenCV"></a>OpenCV</h3><p><a target="_blank" rel="noopener" href="http://opencv.org/">OpenCV</a> is a library of programming functions mainly aimed at real-time computer vision and it contain a video session. However it deal with video well but it save without audio, so it cannot work in this task.</p>
<h3 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h3><p>Later, I found <a target="_blank" rel="noopener" href="http://www.ffmpeg.org/">ffmpeg</a>, which perfectly suit this task.</p>
<p>This is ffmpeg script running in terminel:</p>
<pre><code>ffmpeg [global_options] &#123;[input_file_options] -i input_file&#125; ... &#123;[output_file_options] output_file&#125; ...
</code></pre>
<p>Here I list the commends I used in edit videos.</p>
<p>change the size of a video:</p>
<pre><code>ffmpeg -i input.mkv -s 512x288 output.mkv
</code></pre>
<p>concatenate two videos(the two videos should have the same size, SAR and so on)</p>
<pre><code>ffmpeg -i head.mp4 -i output.mkv -filter_complex &quot;[0:0] [0:1] [1:0] [1:1] concat=n=2:v=1:a=1 [v] [a]&quot; -map &quot;[v]&quot; -map &quot;[a]&quot; output-cat.mkv
</code></pre>
<p>add watermarks:</p>
<pre><code>ffmpeg -i output-cat.mp4 -itsoffset 00:00:05 -t 00:00:08 -i title.png -filter_complex  &#39;[1:v]scale=400:100[s];[0:v][s]overlay=0:main_h-overlay_h&#39; output-mark.avi
</code></pre>
<p>the time after -itsoffset denotes when the mark star to appear, the time after -t is suppose to denote the duration, but it doesn’t work for picture; size of mark(scale = 400:100); position(overlay=10:10), 0:0 denotes leftup, and main_w-overlay_w:main_h-overlay_h denotes right button.</p>
<p>Since watermark cannot appear for a while and hide for a while, I need other way to present the advertisement, and here comes the subtitle.</p>
<p>add subtitle:</p>
<pre><code>ffmpeg -i output-cat.mp4 -i test.srt -map 0:0 -scodec copy -map 1:0 -vcodec copy -map 1:1 -acodec copy output-sub.avi
</code></pre>
<h2 id="python-again"><a href="#python-again" class="headerlink" title="python again"></a>python again</h2><p>All of the commend works on single output, so I turn to python </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">os</span></span><br><span class="line"></span><br><span class="line">work_dir = <span class="string">&#x27;./videos/&#x27;</span></span><br><span class="line">videos = <span class="built_in">os</span>.listdir(work_dir)</span><br><span class="line"></span><br><span class="line"># concatenate head: <span class="number">1.</span> resize flv as -resize.mkv, <span class="number">2.</span> concatenate <span class="number">3.</span> add .srt</span><br><span class="line"><span class="keyword">for</span> video <span class="keyword">in</span> videos:</span><br><span class="line">	# result = <span class="built_in">os</span>.<span class="built_in">popen</span>(<span class="string">&#x27;ffmpeg -i &#x27;</span> + work_dir + video + <span class="string">&#x27; -i ./head.mp4 &#x27;</span> + work_dir +<span class="string">&#x27;combined/&#x27;</span> + video[:<span class="number">-4</span>] + <span class="string">&#x27;combined.mp4&#x27;</span>)</span><br><span class="line">	result = <span class="built_in">os</span>.<span class="built_in">popen</span>(<span class="string">&#x27;ffmpeg -i &#x27;</span>+work_dir + video +<span class="string">&#x27; -s 512x288 &#x27;</span>+work_dir +video[:<span class="number">-4</span>]+<span class="string">&#x27;-resized.mkv&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span> result</span><br><span class="line">	result = <span class="built_in">os</span>.<span class="built_in">popen</span>(<span class="string">&#x27;ffmpeg -i ./head.mp4 -i &#x27;</span>+work_dir + video[:<span class="number">-4</span>]+<span class="string">&#x27;-resized.mkv -filter_complex &quot;[0:0] [0:1] [1:0] [1:1] concat=n=2:v=1:a=1 [v] [a]&quot; -map &quot;[v]&quot; -map &quot;[a]&quot; &#x27;</span> + work_dir +<span class="string">&#x27;combined/&#x27;</span> + video[:<span class="number">-4</span>] + <span class="string">&#x27;combined.mp4&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span> result</span><br><span class="line">	# <span class="built_in">os</span>.<span class="built_in">popen</span>(<span class="string">&#x27;rm &#x27;</span>+work_dir +video[:<span class="number">-4</span>]+<span class="string">&#x27;-resized.mkv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">videos = <span class="built_in">os</span>.listdir(work_dir+<span class="string">&#x27;combined/&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> video <span class="keyword">in</span> videos:</span><br><span class="line">	result = <span class="built_in">os</span>.<span class="built_in">popen</span>(<span class="string">&#x27;ffmpeg -i &#x27;</span> + work_dir + video + <span class="string">&#x27; -i test.srt -scodec copy ./&#x27;</span> + work_dir + video[:<span class="number">-4</span>] + <span class="string">&#x27;added.mkv&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span> result</span><br></pre></td></tr></table></figure>

<p>Here we should have done the task. However, the video I downloaded are in various size and SAR. It seems has no function to ajust SAR directly, so this program has some flaws.</p>
<p>Finally I find what I was doing is recreate wheel, that is there is already a robust software can do this task. 那个软件叫“音影转霸”，可以在<a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1bn70McR">这里</a>下载。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.ffmpeg.org/ffmpeg.html">ffmpeg Document</a>  </li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/5415006/ffmpeg-combine-merge-multiple-mp4-videos-not-working">Combine/merge multiple mp4 videos - not working(from stackoverflow)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.nowamagic.net/academy/detail/1302861">Python urllib urlretrieve</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/kl222/article/details/8159839">水印制作 Watermark</a></li>
<li><a target="_blank" rel="noopener" href="http://m.blog.csdn.net/blog/fanbird2008/14044663">ffmpeg subtitle example</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Video/" rel="tag">Video</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ffmpeg/" rel="tag">ffmpeg</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/12/31/Solution_to_sicp_chapter_1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Solution to Structure and Interpretation of Computer Programs 1
        
      </div>
    </a>
  
  
    <a href="/2014/12/18/Coursera-introduction_to_public_speaking/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Introduction to Public Speaking
        
      </div>
    </a>
  
</nav>

  
</article>


</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Shuang Li<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a><br>
      <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">陕ICP备2021014297号</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-1.4.3.min.js"></script>


  
<script src="/fancybox/jquery.fancybox-1.3.4.js"></script>




<script src="/js/script.js"></script>






<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

  </div>
</body>
</html>